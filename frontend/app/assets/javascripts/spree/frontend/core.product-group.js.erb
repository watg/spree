core.productGroup = {};

var readyProductGroup = function() {
	if (!$('body').hasClass('product-group')) return false;

	core.productGroup.runVariantMethods();
	core.productGroup.getVariants();
	core.productGroup.readyTabs();
	core.productGroup.readyHeroRow();
	core.productGroup.readyRevealContent('knit-your-own');
	core.productGroup.readyHistoryPlugin();
	core.productGroup.readySocialWidget();
	//core.productGroup.readyZoomableImages();
	core.productGroup.showHeroImage();
	core.productGroup.showSelectedVariant();
	core.productGroup.setHeroColour();
	core.productGroup.positionHeroTitle();
	/* ----- New kit UI only ----- */
	core.productGroup.hideOutOfStockVariants();
	core.productGroup.readyAssemblyMenus();
	core.productGroup.closeAssemblyMenus();
	core.productGroup.readyAssemblyItemNames();
	core.productGroup.setAssemblyListHeights();
};


$(document).ready(readyProductGroup);
$(document).on('page:load', readyProductGroup);

/* ----- Init methods ----- */

// Get paginated variants via Ajax
core.productGroup.getVariants = function() {
	var href = $('.pagination a[rel=next]').attr('href');
	//  Die if no more variants to get, otherwise show the spinny...
	if (href == undefined) {
		return false;
	} else {
		core.productGroup.showLoadingImage();
	}

	// Keep getting those variants...
	$.getScript(href).done(function() {
		core.productGroup.hideLoadingImage();
		core.productGroup.runVariantMethods();
		core.productGroup.getVariants();
	});
}

// Run all the methods associated with variants
core.productGroup.runVariantMethods = function() {
	$('.loading-text').remove();

	// Kill existing event handlers before reassigning...
	$('.row-made-by-the-gang').find('*').not('.zoomable').off();

	core.productGroup.readyVariantMenu();
	core.productGroup.readyVariantMixing();
	core.productGroup.readyVariantDetails();
	core.productGroup.readyVariantDetailsClose();
	core.productGroup.readyVariantDetailsArrows();
	core.productGroup.readyLazyLoadImages();
	core.productGroup.readyThumbnailImages();
	core.productGroup.readyPinterestLinks();
	core.productGroup.readyRevealContent('made-by-the-gang');
	core.productGroup.checkForSingleVariant();
	core.productGroup.setAuthToken();

	var visible_entity = $('.displayable-entity:visible');
	if (visible_entity.length > 0) {
		core.suite.readyVariantOptions(visible_entity.first());
	}
	var visible_entity = $('.displayable-kit-entity:visible');
	if (visible_entity.length > 0) {
		core.suite.readyKitVariantOptions(visible_entity.first());
	}
}

core.productGroup.readySocialWidget = function() {
	// Don't show widget on tablet/mobile, or for Gift Cards
	if (core.isTabletWidthOrLess() === false && $('.title h1').text().toLowerCase() != 'gift cards') {
		var widget = $('.widget-social');
		var container = $('.row-social:visible div:first-child');

		// Die if widget already in place
		if (container.find('.widget-social').length > 0) return false;

		// Move widget
		widget.appendTo(container).show();

		// Apply conditional backgrounds when widget carousel loaded
		widget.on('DOMNodeInserted', '.olapic_carousel', function() {
			var thumbs = $(this).find('li').length;
			var prefix = '<%= cdn_prefix %>' + '/product-group/';
			// 1, 2, and 3...
		    if (thumbs > 0 && thumbs < 4) {
				$('.olapic_widget').css('background-image', 'url("' + prefix + 'olapic-widget-background-thumbs.png")');
			} else {
				$('.olapic_widget').css('background-image', 'url("' + prefix + 'olapic-widget-background.png")');
			}
		})
	} else {
		$('.row-social').hide();
	}
}

core.productGroup.readyZoomableImages = function() {
	var images = $('img.zoomable');
	images.load(function() {
		core.productGroup.handleZoomableImage($(this));
	});
}

// Remove space in Pinterest URL (we add the space to prevent Pinterest skinning the button)
core.productGroup.readyPinterestLinks = function() {
	var links = $('.icons-social .pinterest');
	links.off();
	links.on('click', function(e) {
		e.preventDefault();
		location.href = $(this).attr('href').replace('%20button', 'button');
	});
}

core.productGroup.readyTabs = function() {
	$('.tab-made-by-the-gang').on('click', function(e) {
		e.preventDefault();
		core.productGroup.switchContent($(this).attr('class'));
	});
	$('.tab-knit-your-own').on('click', function(e) {
		e.preventDefault();
		core.productGroup.switchContent($(this).attr('class'));
	});
}

// Clicking hero drops the user to the next row
core.productGroup.readyHeroRow = function() {
	var row_hero = $('.row-hero');
	var row_next = row_hero.next('.row');

	row_hero.on('click', function(e) {
		$.scrollTo(row_next, 500, {axis: 'y', easing: 'swing'});
	});
}

core.productGroup.readyVariantMenu = function() {
	if ($('.variant').length <= 3) { // Hide menu if we've got three variants or less
		$('.menu-variants').hide();
		return false;
	} else {
		$('.menu-variants').show();
	}
	$('.menu-variants > li > a').on({
		mouseover: function() {
			$(this).next().show();
		},
		mouseout: function() {
			$(this).next().hide();
		},
		click: function(e) {
			e.preventDefault();
		}
	});
	$('.menu-variants ul').on({
		mouseover: function() {
			$(this).show();
		},
		mouseout: function() {
			$(this).hide();
		}
	});
	$('.menu-variants ul > li > a').on('click', function(e) {
		e.preventDefault();
		core.productGroup.hideAllVariantDetails();
	});
}

core.productGroup.readyVariantMixing = function() {
	if ($('.variant').length == 1) return false; // Don't attempt mix if we've just got a single variant

	$('.variants').mixitup({
		targetSelector: '.variant',
		onMixEnd: function() {
			core.productGroup.readyVariantDetails();
			core.productGroup.triggerLazyLoadImages($('.variants'));
		}
	});
}

core.productGroup.readyVariantDetails = function() {
	core.productGroup.tagFirstInRowVariants();

	$('.variant').on('click', 'a', function(e) {
		e.preventDefault();
		var variant = $(this).parent().attr('data-variant');
		core.productGroup.showVariantDetails(variant, null);
	});
}

core.productGroup.readyVariantDetailsClose = function() {
	$('.close').on('click', function(e) {
		e.preventDefault();
		$(this).closest('li').slideUp(500);

		//$('.zoomContainer').remove(); // Kill zoom containers

		// Update URL
		var path = core.getUrlPathAsArray();
		History.replaceState(null, null, '/' + path[1] + '/' + path[2] + '/' + path[3] + '/' + path[4]);
	});
}

core.productGroup.readyVariantDetailsArrows = function() {
	$('.arrow.prev').on('click', function(e) {
		e.preventDefault();
		var variant = $(this).parent().attr('data-variant');
		core.productGroup.showPrevVariantDetails(variant);
	});
	$('.arrow.next').on('click', function(e) {
		e.preventDefault();
		var variant = $(this).parent().attr('data-variant');
		core.productGroup.showNextVariantDetails(variant);
	});
}

core.productGroup.readyLazyLoadImages = function() {
	$('img.lazy-load').lazyload({
		event: 'scrollstop',
		load: function() {
			$(this).removeClass('lazy-load');
		}
	});
}

core.productGroup.readyThumbnailImages = function() {
	$('.thumbnails a').on('click', function(e) {
		e.preventDefault();
		var image = $('.main-image:visible img'); // The visible main image (VMI)
		image.attr('src', $(this).attr('href')); // Update the VMI
		$.scrollTo(image, 500, {axis: 'y', easing: 'swing'}); // Scroll to the VMI
	});
}

core.productGroup.readyRevealContent = function(row) {
	var title = row == 'made-by-the-gang' ? $('.row-made-by-the-gang .reveal-title') : $('.row-knit-your-own .reveal-title');

	title.on('click', function() {
		$(this).next('.reveal-content').toggle();
		$(this).toggleClass('revealed');
	});
}

// Readies history.js
core.productGroup.readyHistoryPlugin = function() {
	(function(window, undefined) {
		// Prepare
		var History = window.History; // Note: We are using a capital H instead of a lower h
		if (!History.enabled) {
			// History.js is disabled for this browser.
			// This is because we can optionally choose to support HTML4 browsers or not.
			return false;
		}

		// Bind to StateChange Event
		History.Adapter.bind(window, 'statechange', function() { // Note: We are using statechange instead of popstate
			var State = History.getState(); // Note: We are using History.getState() instead of event.state
			//History.log(State.data, State.title, State.url);
		});
	})(window);
}

core.productGroup.showSelectedVariant = function() {
	var variant = $('.row-hero').attr('data-selected-variant-id');
	var details = $(".details[data-variant='" + variant + "']");

	if (variant == undefined || details == undefined) return false;
	core.productGroup.showVariantDetails(variant, null);
}

// Only one variant? Then expose the details panel and hide the arrows/close button
core.productGroup.checkForSingleVariant = function() {
	var variant = $('.variant');

	if (variant.length == 1) {
		variant.hide();
		$('.arrow.prev').hide();
		$('.arrow.next').hide();
		$('.close').hide();
		$('.details').show();
	}
}

core.productGroup.showHeroImage = function() {
	var row = $('.row-hero');
	row.css('background-image', 'none'); // Clear current image
	var src = row.hasClass('made-by-the-gang') ? row.attr('data-hero-made-by-the-gang') : row.attr('data-hero-knit-your-own');
	if (src == undefined) return false;
	$('<img/>').attr('src', src).load(function() {
		$(this).remove(); // Prevent memory leaks
		row.css('background-image', 'url(' + src + ')');
	});

	// Adjust hero row for mobile/tablet
	if (core.isTabletWidthOrLess() === true) {
		var height_row = row.outerHeight();
		var height_title = $('.title').outerHeight();
		var height_remains = height_row - height_title;
		row.css('background-size', 'auto ' + height_remains + 'px');
		row.css('background-position', '0 ' + height_title + 'px');
		// Pull image 60px left for mobile
		if (core.isMobileWidthOrLess() === true) {
			row.css('background-position', '-60px ' + height_title + 'px');
		}
	}
}

core.productGroup.setHeroColour = function() {
	var row = $('.row-hero');
	var colour = row.hasClass('made-by-the-gang') ? row.attr('data-hero-made-by-the-gang-colour') : row.attr('data-hero-knit-your-own-colour');
	if (colour == undefined) return false;
	row.css('background-color', '#' + colour);
}

// Use JS to vertically centre the hero title
core.productGroup.positionHeroTitle = function() {
	if (core.isTabletWidthOrLess() === false) {
		var title = $('.title');
		var title_height = title.outerHeight();
		var row_height = $('.row-hero').outerHeight();
		var tab_height = $('.tab-made-by-the-gang').outerHeight();
		var margin = (row_height - tab_height - title_height) / 2;
		title.css('margin-top', margin);
	}
}

core.productGroup.hideOutOfStockVariants = function() {
	var definitionId = $('.row-assembly').data('ad-id');
	if (definitionId == null || definitionId == 'undefined') return false; // Die if not new kit UI

	var path = "<%= api_assembly_definitions_option_values_out_of_stock_path(id: ':id') %>".replace(":id", definitionId);
	$.get(path, function(data){
		for(part_id in data.parts){
			var partScope = '.product-variants[data-adp-id='+part_id+']';
			$.each(data.parts[part_id], function(i, ovidList){
				$.each(ovidList, function(i, ovid){
					$('.variant-option-values [data-ov-id='+ovid+']', partScope).hide();
				});
			});
		}
	});
}

core.productGroup.readyAssemblyMenus = function() {
	var row = $('.row-assembly');
	if (row.length == 0) return false; // Die if not new kit UI

	row.find('.product-variants').on('click', function(e) {
		e.stopPropagation();
		$(this).siblings().removeClass('revealed').find('.variant-options').hide();
		$(this).find('.variant-options').toggle();
		$(this).toggleClass('revealed');
	});
}

core.productGroup.closeAssemblyMenus = function() {
	$('.row-made-by-the-gang, .row-knit-your-own').on('click', function() {
		$(this).find('.product-variants.revealed').click();
	});
}

// Ensure item names are clickable
core.productGroup.readyAssemblyItemNames = function() {
	var row = $('.row-assembly');
	if (row.length == 0) return false; // Die if not new kit UI

	row.find('.assembly-name').on('click', function(e) {
	  e.stopPropagation();
	  $(this).prev().click();
	});
}

// Make menu and image list items exactly the same height
core.productGroup.setAssemblyListHeights = function() {
	var row = $('.row-assembly');
	if (row.length == 0) return false; // Die if not new kit UI

	$.each($('.assembly-menus ol > li'), function(index, value) {
		$('.assembly-images li').eq(index).css('height', $(this).outerHeight());
	});
}

core.productGroup.setAuthToken = function() {
	var token = $("input[name='authenticity_token_fresh']").val();
	$("input[name='authenticity_token']").val(token);
}

/* ----- Non-init methods ----- */

core.productGroup.switchContent = function(tab) {
	switch(tab) {
		case 'tab-made-by-the-gang':
		// Hero
		$('.row-hero').addClass('made-by-the-gang').removeClass('knit-your-own');
		$('.row-hero .title').removeClass('inverted');
		core.productGroup.showHeroImage();
		core.productGroup.setHeroColour();
		// Tabs
		$('.tab-made-by-the-gang').closest('div').addClass('active');
		$('.tab-knit-your-own').closest('div').removeClass('active');
		// Content
		$('.row-made-by-the-gang').addClass('active');
		$('.row-knit-your-own').removeClass('active');
		// Supporting content
		$('.row-knit-your-own-supporting').removeClass('active');
		// Tag 'first in row' variants
		core.productGroup.tagFirstInRowVariants();
		// Hide open variants
		//core.productGroup.hideAllVariantDetails();
		// Update URL
		var path = core.getUrlPathAsArray();
		History.replaceState(null, null, '/' + path[1] + '/' + path[2] + '/' + path[3] + '/' + 'made-by-the-gang');
		// Update social links
		core.productGroup.updateSocialLinks('made-by-the-gang');
		// Social widget
		core.productGroup.readySocialWidget();
		break;

		case 'tab-knit-your-own':
		// Hero
		$('.row-hero').removeClass('made-by-the-gang').addClass('knit-your-own');
		$('.row-hero .title').addClass('inverted');
		core.productGroup.showHeroImage();
		core.productGroup.setHeroColour();
		// Tabs
		$('.tab-made-by-the-gang').closest('div').removeClass('active');
		$('.tab-knit-your-own').closest('div').addClass('active');
		// Content
		$('.row-made-by-the-gang').removeClass('active');
		$('.row-knit-your-own').addClass('active');
		// Supporting content
		$('.row-knit-your-own-supporting').addClass('active');
		// Update URL
		var path = core.getUrlPathAsArray();
		History.replaceState(null, null, '/' + path[1] + '/' + path[2] + '/' + path[3] + '/' + 'knit-your-own');
		// Update social links
		core.productGroup.updateSocialLinks('knit-your-own');
		// Social widget
		core.productGroup.readySocialWidget();
		// Load lazy
		core.productGroup.triggerLazyLoadImages($('.row-knit-your-own'));
		break;
  }

  // Init variant options
  var displayableKitEntity = $('.displayable-kit-entity:visible')
  var displayableEntity = $('.displayable-entity:visible')

  if (displayableKitEntity.length > 0) {
		core.suite.readyKitVariantOptions(displayableKitEntity);
  }
  else if (displayableEntity.length > 0) {
		core.suite.readyVariantOptions(displayableEntity);
  }
}

core.productGroup.showVariantDetails = function(name, before) {
	core.productGroup.hideAllVariantDetails();

	var details = $(".details[data-variant='" + name + "']");
	var variant = $(".variant[data-variant='" + name + "']");
	var number = variant.attr('data-variant-number');

	// Load lazy images before reveal
	core.productGroup.triggerLazyLoadImages(details);

	// Pre-select the correct option values
	core.suite.readyVariantOptions(details);

	// Do we have an element we'd like to insert before?
	if (before != null) {
		details.insertBefore(before);
	} else {
		// Insert before the variant that's positioned first in the same row
		if (variant.hasClass('first-in-row')) {
			details.insertBefore(variant);
		} else {
			details.insertBefore(variant.prevAll('.first-in-row:first'));
		}
	}

	details.show();

	// Social widget
	core.productGroup.readySocialWidget();

	// Update URL
	var path = core.getUrlPathAsArray();

	// If we have a query string, ensure we append it to the updated URL
	var query = ''
	if (window.location.search) {
		query = window.location.search;
	}

	// Do the update...
	History.replaceState(null, null, '/' + path[1] + '/' + path[2] + '/' + path[3] + '/' + path[4] + '/' + number + query);

	// Don't scroll when we're supplying an element to insert before
	if (before == null) {
		$.scrollTo(details, 500, {axis: 'y', easing: 'swing'});
	}
}

core.productGroup.showPrevVariantDetails = function(name) {
	var details = $(".details[data-variant='" + name + "']");
	var variant = $(".variant[data-variant='" + name + "']");
	var prev_variant = variant.prevAll('.variant:visible').first().attr('data-variant');

	// At loop start, jump to end
	if (prev_variant == undefined) {
		prev_variant = $('.variant:visible').last().attr('data-variant');
	}

	core.productGroup.showVariantDetails(prev_variant, details);
}

core.productGroup.showNextVariantDetails = function(name) {
	var details = $(".details[data-variant='" + name + "']");
	var variant = $(".variant[data-variant='" + name + "']");
	var next_variant = variant.nextAll('.variant:visible').first().attr('data-variant');

	// At loop end, jump to start
	if (next_variant == undefined) {
		next_variant = $('.variant:visible').first().attr('data-variant');
	}

	core.productGroup.showVariantDetails(next_variant, details);
}

core.productGroup.hideAllVariantDetails = function() {
	$('.details').hide();
}

// Make sure we know which variants are positioned first in row
core.productGroup.tagFirstInRowVariants = function() {
	$('.variant').removeClass('first-in-row');
	$('.variant:visible').each(function(i) {
		var mod = core.isTabletWidthOrLess() === true ? 1 : 3; // If mobile/tablet, every variant is first in row
		if (i % mod == 0) $(this).addClass('first-in-row');
	});
}

// Force load of lazy images
core.productGroup.triggerLazyLoadImages = function(container) {
	container.find('img.lazy-load').each(function() {
		$(this).attr('src', $(this).attr('data-original'));
		$(this).removeAttr('data-original');
		$(this).removeClass('lazy-load');
	});
}

core.productGroup.updateSocialLinks = function(tab) {
	var links = $('.icons-social a');

	links.each(function() {
		if (tab == 'knit-your-own') {
			this.href = this.href.replace('made-by-the-gang', 'knit-your-own');
		} else {
			this.href = this.href.replace('knit-your-own', 'made-by-the-gang');
		}
	});
}

core.productGroup.showLoadingImage = function() {
  $('<%= cdn_image_tag("product-group/loading.gif", class: "loading-image", width: "60", height: "60",  alt: "") %>').insertAfter($('.variants'));
}

core.productGroup.hideLoadingImage = function() {
	$('.loading-image').remove();
}

core.productGroup.handleZoomableImage = function(image) {
	if (image.data('elevateZoom')) { // If image already has zoom instance, just change the zoom image...
		$('.zoomWindowContainer div').stop().css('background-image', 'url(' + image.attr('src').replace('product', 'original') + ')');
	} else { // Init zoom instance
		image.elevateZoom({ responsive: true, zoomType: 'inner', cursor: 'crosshair', zoomWindowFadeIn: 250, zoomWindowFadeOut: 250 });
	}
}

// Social Widgets are loaded from core.suite.js.erb