<%#encoding: UTF-8%>
// variant autocompletion

$(document).ready(function() {

  if ($('#variant_autocomplete_template').length > 0) {
    window.variantTemplate = Handlebars.compile($('#variant_autocomplete_template').text());
    window.variantStockTemplate = Handlebars.compile($('#variant_autocomplete_stock_template').text());
  }
});

formatVariantResult = function(variant) {
  if (variant["images"][0] != undefined && variant["images"][0].urls != undefined) {
    variant.image = variant.images[0].urls.mini
  }

  variantTemplate = Handlebars.compile($('#variant_autocomplete_template').text());
  return variantTemplate({ variant: variant })
}

$.fn.variantAutocomplete = function(product_page_id) {
  this.parent().children(".options_placeholder").attr('id', this.parent().data('index'))
  this.select2({
    placeholder: Spree.translations.variant_placeholder,
    minimumInputLength: 3,
    initSelection: function (element, callback) {
      url = Spree.url(Spree.routes.variants_search, {
        id: element.val()
      });
      $.getJSON(url, null, function(data) {
        callback(data['variants'][0]);
      });
    },
    ajax: {
      url: Spree.url(Spree.routes.variants_search),
      datatype: 'json',
      data: function(term, page) {
        var params = {
          q: {
            'product_name_or_sku_cont': term
          }
        };

        if(product_page_id) {
          params['product_page_id'] = product_page_id;
        }
        
        return params;
      },
      results: function (data, page) {
        window.variants = data['variants'];

        return { results: data['variants'] }
      }
    },
    formatResult: formatVariantResult,
    formatSelection: function (variant) {
      $(this.element).parent().children('.options_placeholder').html(variant.options_text)
      return variant.name;
    }
  })
}
