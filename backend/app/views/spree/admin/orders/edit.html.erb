<% content_for :page_actions do %>
  <% if can?(:fire, @order) %>
    <li><%= event_links %></li>
  <% end %>
  <% if can?(:resend, @order) %>
    <li><%= button_link_to Spree.t(:resend), resend_admin_order_url(@order), :method => :post, :icon => 'email' %></li>
  <% end %>
  <% if can?(:admin, Spree::Order) %>
    <li><%= button_link_to Spree.t(:back_to_orders_list), admin_orders_path, :icon => 'arrow-left' %></li>
  <% end %>
<% end %>

<%= render :partial => 'spree/admin/shared/order_tabs', :locals => { :current => 'Order Details' } %>

<div data-hook="admin_order_edit_header">
  <%= render :partial => 'spree/shared/error_messages', :locals => { :target => @order } %>
</div>

<%# if @order.payments.exists? && @order.considered_risky? %>
  <%# render 'spree/admin/orders/risk_analysis', latest_payment: @order.payments.order("created_at DESC").first %>
<%# end %>


<div class="row">
  <div class="alpha three columns">
    <% button_title = @order.internal? ? "Use Metapack" : "Make Internal" %>
    <%= button_link_to(button_title, internal_admin_order_url(@order), :icon => 'icon-arrow-right', :method => :post) %>
  </div>

  <div class="alpha three columns">
    <% button_title = @order.important? ? "Make normal" : "Make Important" %>
    <% icon = @order.important? ? 'icon-hand-down' : 'icon-hand-up' %>
    <%= button_link_to(button_title, important_admin_order_url(@order), :icon => icon, :method => :post) %>
  </div>

  <div class="three columns">
    <%= button_link_to("Refresh", refresh_admin_order_url(@order), :icon => 'icon-refresh', :method => :post  ) %>
  </div>

  <div class="three columns">
    <% if @order.has_gift_card? %>
      <%= button_to('Re-Issue Gift Card', :action => 'gift_card_reissue') %>
    <% end %>
  </div>

</div>

<% if @order.active_hold_note.present? %>
<p>
  This item was put on hold
  <%= distance_of_time_in_words(Time.now, @order.active_hold_note.created_at) %> ago by
  <%= @order.active_hold_note.user.email %>.

  <%= link_to "See more...", admin_order_hold_path(@order, @order.active_hold_note) %>
</p>
<% end %>

<%= render :partial => 'add_product' if can?(:update, @order) %>

<% if @order.line_items.empty? %>
  <div class="no-objects-found">
    <%= Spree.t(:your_order_is_empty_add_product)%>
  </div>
<% end %>

<div data-hook="admin_order_edit_form">
  <div id="order-form-wrapper">
    <%= render :partial => 'form', :locals => { :order => @order } %>
  </div>
</div>

<% content_for :head do %>
  <%= javascript_tag 'var expand_variants = true;' %>
<% end %>


<%= javascript_tag do %>
$(document).ready(function () {
  window.variantOptionsTemplate = Handlebars.compile($("#variant_options_template").text());

  $("#stock_details").on("assemblyDefinition.parts.update",".part-options", function(evt){
    evt.preventDefault();
    var $self = $(this);
    $.ajax({
      url: $(this).data('url'),
      dataType: 'json',
      success: function(assembly_definition_part) {
        $self.data('key',  assembly_definition_part.id);
        $self.append(variantOptionsTemplate({available_variants: assembly_definition_part.variants}));
     }
    });
  });

});
<% end -%>
