<tr id="<%= spree_dom_id image %>" data-hook="images_row" class="<%= cycle('odd', 'even')%>">
  <td class="no-border">
    <span class="handle"></span>
  </td>
  <td>
    <% if image.processed? %>
      <%= link_to image_tag(image.attachment.url(:small), style: "max-width: 180px"), image.attachment.url(:product) %>
    <% else %>
      <%= link_to image_tag(image.direct_upload_url, style: "max-width: 180px"), image.attachment.url(:product) %>
    <% end %>
  </td>
  
  <td>
    <%= form_tag spree.admin_product_image_path(@product,image), remote: true, :method => :put, :class => "edit_image", :id => "edit_image_#{image.id}" do %>

    <% personalisation = ( image.viewable_type == 'Spree::Personalisation' ) %>
    <%= label_tag :toggle_variant_personalisation, 'Toggle variant / personalisation' %><br>
    <%= check_box_tag 'image[activate_personalisation]', image.id, personalisation, class: 'activate_personalisation' %>

    <% if personalisation %>
      <% image_variant_hidden = 'hidden' %>
      <% image_personalisation_hidden = '' %>
    <% else %>
      <% image_variant_hidden = '' %>
      <% image_personalisation_hidden = 'hidden' %>
    <% end %>

    <fieldset>
      <%= label :target_id, "Target" %><br>
      <%= select_tag 'image[target_id]', options_from_collection_for_select(Spree::Target.all, 'id', 'name', image.try(:target_id)), include_blank: true, class: 'select2' %>
      <br><br>
    </div>

      <div class='<%="image-personalisation-#{image.id} #{image_personalisation_hidden}"%>'>
      <%= label :personalisation, 'personalisation: ' %>
      <%= select_tag 'image[personalisation_id]', options_for_select( @product.personalisations.map {|p| [p.name, p.id]}, get_personalisation_id(image) ), { :include_blank => Spree.t('match_choices.none'), :class => 'select2 fullwidth'} %>
      <br><br>
    </div>
    </fieldset>

  <% end %>
  </td>           

  <td class="actions">
    <%= link_to '', '#', :class => 'save-item icon_link icon-ok no-text with-tip', :title => Spree.t('actions.save'), :onclick=>"$('#edit_image_#{image.id}').submit(); return false;" %>

    <%= link_to_with_icon 'edit', Spree.t(:edit), edit_admin_product_image_url(@product, image), :no_text => true, :data => {:action => 'edit'} %>
    <%= link_to_delete image, { :url => admin_product_image_url(@product, image), :no_text => true } %>
  </td>
</tr>
